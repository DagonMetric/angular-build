{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../src/webpack/plugins/try-bundle-dll-webpack-plugin/index.ts"],"names":[],"mappings":"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","sourcesContent":["import * as fs from 'fs';\r\n// ReSharper disable once CommonJsExternalModule\r\nconst webpack = require('webpack');\r\n\r\nconst webpackOutputOptions = {\r\n    colors: true,\r\n    hash: true,\r\n    timings: true,\r\n    chunks: true,\r\n    chunkModules: false,\r\n    children: false, // listing all children is very noisy in AOT and hides warnings/errors\r\n    modules: false,\r\n    reasons: false,\r\n    warnings: true,\r\n    assets: false, // listing all assets is very noisy when using assets directories\r\n    version: false\r\n};\r\n\r\nconst verboseWebpackOutputOptions = {\r\n    children: true,\r\n    assets: true,\r\n    version: true,\r\n    reasons: true,\r\n    chunkModules: false // TODO: set to true when console to file output is fixed\r\n};\r\n\r\nfunction getWebpackStatsConfig(verbose = false) {\r\n    return verbose\r\n        ? Object.assign(webpackOutputOptions, verboseWebpackOutputOptions)\r\n        : webpackOutputOptions;\r\n}\r\n\r\n\r\nexport interface TryBundleDllPluginOptions {\r\n    manifestFile: string;\r\n    webpackDllConfig: any;\r\n    debug?: boolean;\r\n}\r\n\r\nexport class TryBundleDllWebpackPlugin {\r\n\r\n    constructor(private readonly options: TryBundleDllPluginOptions) {\r\n    }\r\n\r\n    apply(compiler: any) {\r\n        compiler.plugin('run', (c: any, next: any) => this.tryDll(next));\r\n        compiler.plugin('watch-run', (c: any, next: any) => this.tryDll(next));\r\n    }\r\n\r\n\r\n    tryDll(next: (err?: Error) => any): void {\r\n        this.checkManifestFile()\r\n            .then((exists: boolean) => {\r\n                if (exists) {\r\n                    return Promise.resolve(null);\r\n                } else {\r\n                    const webpackDllConfig = this.options.webpackDllConfig;\r\n                    const webpackCompiler: any = webpack(webpackDllConfig);\r\n                    const statsConfig = getWebpackStatsConfig(this.options.debug);\r\n\r\n                    return new Promise((resolve, reject) => {\r\n                        const callback = (err: any, stats: any) => {\r\n                            if (err) {\r\n                                return reject(err);\r\n                            }\r\n\r\n                            console.info(stats.toString(statsConfig));\r\n\r\n                            // TODO:\r\n                            //if (watch) {\r\n                            //  return;\r\n                            //}\r\n\r\n                            if (stats.hasErrors()) {\r\n                                reject();\r\n                            } else {\r\n                                resolve();\r\n                            }\r\n                        };\r\n\r\n                        webpackCompiler.run(callback);\r\n                        // TODO:\r\n                        //if (watch) {\r\n                        //  webpackCompiler.watch({}, callback);\r\n                        //} else {\r\n                        //  webpackCompiler.run(callback);\r\n                        //}\r\n                    });\r\n                }\r\n            })\r\n            .then(() => next())\r\n            .catch((err: Error) => next(err));\r\n    }\r\n\r\n    private checkManifestFile() {\r\n        return new Promise((resolve, reject) => {\r\n            return fs.stat(this.options.manifestFile, (err, stats) => {\r\n                if (err) {\r\n                    return reject(err);\r\n                }\r\n                return resolve(stats.isFile());\r\n            });\r\n        });\r\n    }\r\n\r\n}"]}